name: Code Test
on:
  push:
    branches:
        - main
  pull_request:
    types: [opened, synchronize, reopened]
jobs:
  changes:
    permissions:
      pull-requests: read
      contents: read
    name: Identify File Changes
    runs-on: ubuntu-latest
    outputs:
      paths: ${{ steps.filter.outputs.changes }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
             date-helpers:
              - 'packages/date-helpers/**'
             hello-world-util:
              - 'packages/hello-world-util/**'
             feature-flags:
              - 'packages/feature-flags/**'
             string-utils:
              - 'packages/string-utils/**'
             task-queue-manager:
              - 'packages/task-queue-manager/**'
             nestjs-startup-app:
              - 'starters/nestjs-startup-app/**'
            
  tests:
    name: Run Tests
    needs: changes
    permissions:
      pull-requests: write
      contents: read
      checks: write
    strategy:
      matrix:
        include:
          - filter: date-helpers
            projectDirectory: packages/date-helpers
            nodeVersion: 'lts/*'
          - filter: hello-world-util
            projectDirectory: packages/hello-world-util
            nodeVersion: 'lts/*'
          - filter: feature-flags
            projectDirectory: packages/feature-flags
            nodeVersion: 'lts/*'
          - filter: string-utils
            projectDirectory: packages/string-utils
            nodeVersion: 'lts/*'
          - filter: task-queue-manager
            projectDirectory: packages/task-queue-manager
            nodeVersion: 'lts/*'
          - filter: nestjs-startup-app
            projectDirectory: starters/nestjs-startup-app
            nodeVersion: 'lts/*'
   
    uses: ./.github/actions/setup-test-project
    with:
      projectDirectory: ${{ matrix.projectDirectory }}
      nodeVersion: ${{ matrix.nodeVersion }}